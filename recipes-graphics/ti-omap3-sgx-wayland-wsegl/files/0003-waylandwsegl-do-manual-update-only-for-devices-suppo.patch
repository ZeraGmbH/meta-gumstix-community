From d2f71f888afa34849abc12352afad2a090f068e2 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andreas=20M=C3=BCller?= <schnitzeltony@googlemail.com>
Date: Tue, 4 Feb 2014 09:43:56 +0100
Subject: [PATCH 3/5] waylandwsegl: do manual update only for devices
 supporting OMAPFB_UPDATE_WINDOW
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Andreas MÃ¼ller <schnitzeltony@googlemail.com>
---
 wsegl/waylandwsegl.c | 29 +++++++++++++++++++++--------
 1 file changed, 21 insertions(+), 8 deletions(-)

diff --git a/wsegl/waylandwsegl.c b/wsegl/waylandwsegl.c
index 01a9d30..a90d570 100644
--- a/wsegl/waylandwsegl.c
+++ b/wsegl/waylandwsegl.c
@@ -265,6 +265,7 @@ int wayland_roundtrip(struct wl_egl_display *display)
     return ret;
 }
 
+static bool manual_update_supported = false;
 
 /* Initialize a native display for use with WSEGL */
 static WSEGLError wseglInitializeDisplay
@@ -308,6 +309,16 @@ static WSEGLError wseglInitializeDisplay
           close(fd);
           return WSEGL_CANNOT_INITIALISE; 
        }
+       struct omapfb_caps fb_caps;
+       if (ioctl(fd, OMAPFB_GET_CAPS, &fb_caps) < 0) {
+          perror("OMAPFB_GET_CAPS");
+       }
+       else {
+	   wsegl_info("wayland-wsegl: fb caps: %08X", fb_caps.ctrl);
+	   if (fb_caps.ctrl & OMAPFB_CAPS_MANUAL_UPDATE) {
+	       manual_update_supported = true;
+           }
+       }
        egldisplay->fd = fd;
        format = getwseglPixelFormat(egldisplay);
 
@@ -641,16 +652,18 @@ static WSEGLError wseglSwapDrawable
           (drawable->display->context, drawable->frontBufferPVRMEM, 1);                      
        assert (drawable->display->fd >= 0);
 
+       if(manual_update_supported)
+       {
+           struct omapfb_update_window update_window;
 
-       struct omapfb_update_window update_window;
-         
-       update_window.x = update_window.out_x = 0;
-       update_window.y = update_window.out_y = 0;
-       update_window.width = update_window.out_width = drawable->width;
-       update_window.height = update_window.out_height = drawable->height;
-       update_window.format = 0;
+           update_window.x = update_window.out_x = 0;
+           update_window.y = update_window.out_y = 0;
+           update_window.width = update_window.out_width = drawable->width;
+           update_window.height = update_window.out_height = drawable->height;
+           update_window.format = 0;
 
-       assert(ioctl(drawable->display->fd, OMAPFB_UPDATE_WINDOW, &update_window) == 0);
+           assert(ioctl(drawable->display->fd, OMAPFB_UPDATE_WINDOW, &update_window));
+        }
     }
     
     drawable->currentBackBuffer   
-- 
1.8.3.1

