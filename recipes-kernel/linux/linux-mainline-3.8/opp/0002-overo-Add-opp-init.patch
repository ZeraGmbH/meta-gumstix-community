From eec95b53f2f3fb2b3edaafeb79d869397b634429 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andreas=20M=C3=BCller?= <schnitzeltony@googlemail.com>
Date: Wed, 27 Feb 2013 11:16:20 +0100
Subject: [PATCH 2/2] overo: Add opp init
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

based on beagleboard init code

Signed-off-by: Andreas MÃ¼ller <schnitzeltony@googlemail.com>
---
 arch/arm/mach-omap2/board-overo.c |   52 +++++++++++++++++++++++++++++++++++++
 1 files changed, 52 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/board-overo.c b/arch/arm/mach-omap2/board-overo.c
index eef8cc5..850268c 100644
--- a/arch/arm/mach-omap2/board-overo.c
+++ b/arch/arm/mach-omap2/board-overo.c
@@ -34,6 +34,7 @@
 #include <linux/spi/ads7846.h>
 #include <linux/cpu.h>
 #include <linux/usb/musb.h>
+#include <linux/opp.h>
 
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/nand.h>
@@ -52,6 +53,7 @@
 #include <video/omap-panel-generic-dpi.h>
 #include <video/omap-panel-tfp410.h>
 
+#include "soc.h"
 #include "common.h"
 #include "mux.h"
 #include "sdram-micron-mt46h32m32lf-6.h"
@@ -59,6 +61,8 @@
 #include "hsmmc.h"
 #include "board-flash.h"
 #include "common-board-devices.h"
+#include "pm.h"
+#include "omap_device.h"
 
 #define	NAND_CS			0
 
@@ -611,6 +615,54 @@ static struct omap_musb_board_data musb_board_data = {
        .power                  = 500,
 };
 
+#if defined(CONFIG_PM_OPP) || \
+	defined(CONFIG_PM_OPP_MODULE)
+static int __init overo_opp_init(void)
+{
+	int r;
+
+	/* Initialize the omap3 opp table if not already created. */
+	r = omap3_opp_init();
+	if (IS_ERR_VALUE(r) && (r != -EEXIST)) {
+		pr_err("%s: opp default init failed\n", __func__);
+		return r;
+	}
+
+	/* Custom OPP enabled for 36/3730 */
+	if (cpu_is_omap3630()) {
+		struct device *mpu_dev, *iva_dev;
+
+		mpu_dev = get_cpu_device(0);
+		iva_dev = omap_device_get_by_hwmod_name("iva");
+
+		if (IS_ERR(mpu_dev) || IS_ERR(iva_dev)) {
+			pr_err("%s: Aiee.. no mpu/dsp devices? %p %p\n",
+				__func__, mpu_dev, iva_dev);
+			return -ENODEV;
+		}
+		/* Enable MPU 800MHz */
+		r = opp_enable(mpu_dev, 800000000);
+		/* TODO: MPU 1GHz needs SR and ABB */
+
+		/* Enable IVA 660MHz */
+		r |= opp_enable(iva_dev, 660000000);
+		/* TODO: DSP 800MHz needs SR and ABB */
+		if (r) {
+			pr_err("%s: failed to enable higher opp %d\n",
+				__func__, r);
+			/*
+			 * Cleanup - disable the higher freqs - we dont care
+			 * about the results
+			 */
+			opp_disable(mpu_dev, 800000000);
+			opp_disable(iva_dev, 660000000);
+		}
+	}
+	return 0;
+}
+device_initcall(overo_opp_init);
+#endif
+
 static void __init overo_init(void)
 {
 	int ret;
-- 
1.7.6.5

